import{_ as a,c as s,o as n,a8 as e}from"./chunks/framework.DDO5B0CJ.js";const l="/vitepress-java/assets/img_50.DHU6DJgG.png",i="/vitepress-java/assets/img_51.AO3DRgrq.png",p="/vitepress-java/assets/img_52.DjPtnVaG.png",k=JSON.parse('{"title":"Gitlab 运维","description":"","frontmatter":{},"headers":[],"relativePath":"soft/Gitlab.md","filePath":"soft/Gitlab.md"}'),t={name:"soft/Gitlab.md"},r=e('<h1 id="gitlab-运维" tabindex="-1">Gitlab 运维 <a class="header-anchor" href="#gitlab-运维" aria-label="Permalink to &quot;Gitlab 运维&quot;">​</a></h1><h2 id="一、gitlab-安装" tabindex="-1">一、gitlab 安装 <a class="header-anchor" href="#一、gitlab-安装" aria-label="Permalink to &quot;一、gitlab 安装&quot;">​</a></h2><h2 id="gitlab-的普通安装" tabindex="-1">Gitlab 的普通安装 <a class="header-anchor" href="#gitlab-的普通安装" aria-label="Permalink to &quot;Gitlab 的普通安装&quot;">​</a></h2><h2 id="下载" tabindex="-1">下载 <a class="header-anchor" href="#下载" aria-label="Permalink to &quot;下载&quot;">​</a></h2><p>进入官方下载地址：<a href="https://about.gitlab.com/install/" target="_blank" rel="noreferrer">https://about.gitlab.com/install/</a> ，如下图，选择合适的版本。</p><p><img src="'+l+`" alt="img_50.png" loading="lazy"></p><p>以 CentOS7 为例：</p><h2 id="安装和配置必要依赖" tabindex="-1">安装和配置必要依赖 <a class="header-anchor" href="#安装和配置必要依赖" aria-label="Permalink to &quot;安装和配置必要依赖&quot;">​</a></h2><p>在系统防火墙中启用 HTTP 和 SSH</p><div class="language-angular2html vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">angular2html</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>sudo yum install -y curl policycoreutils-python openssh-server</span></span>
<span class="line"><span>sudo systemctl enable sshd</span></span>
<span class="line"><span>sudo systemctl start sshd</span></span>
<span class="line"><span>sudo firewall-cmd --permanent --add-service=http</span></span>
<span class="line"><span>sudo systemctl reload firewalld</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>安装 Postfix ，使得 Gitlab 可以发送通知邮件</p><div class="language-angular2html vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">angular2html</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>sudo yum install postfix</span></span>
<span class="line"><span>sudo systemctl enable postfix</span></span>
<span class="line"><span>sudo systemctl start postfix</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>添加 Gitlab yum 仓库并安装包</p><p>添加 Gitlab yum 仓库</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>curl https://packages.gitlab.com/install/repositories/gitlab/gitlab-ce/script.rpm.sh | sudo bash</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>通过 yum 安装 gitlab-ce</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>sudo EXTERNAL_URL=&quot;http://gitlab.example.com&quot; yum install -y gitlab-ce</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>安装完成后，即可通过默认的 root 账户进行登录。</p><h1 id="gitlab-的-docker-安装" tabindex="-1">Gitlab 的 Docker 安装 <a class="header-anchor" href="#gitlab-的-docker-安装" aria-label="Permalink to &quot;Gitlab 的 Docker 安装&quot;">​</a></h1><p>拉取镜像</p><div class="language-angular2html vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">angular2html</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>docker pull docker.io/gitlab/gitlab-ce</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>启动</p><div class="language-angular2html vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">angular2html</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>docker run -d \\</span></span>
<span class="line"><span>--hostname gitlab.zp.io \\</span></span>
<span class="line"><span>--publish 8443:443 --publish 80:80 --publish 2222:22 \\</span></span>
<span class="line"><span>--name gitlab \\</span></span>
<span class="line"><span>--restart always \\</span></span>
<span class="line"><span>--volume $GITLAB_HOME/config:/etc/gitlab \\</span></span>
<span class="line"><span>--volume $GITLAB_HOME/logs:/var/log/gitlab \\</span></span>
<span class="line"><span>--volume $GITLAB_HOME/data:/var/opt/gitlab \\</span></span>
<span class="line"><span>gitlab/gitlab-ce</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p><img src="`+i+`" alt="img_51.png" loading="lazy"></p><h1 id="自签名证书" tabindex="-1">自签名证书 <a class="header-anchor" href="#自签名证书" aria-label="Permalink to &quot;自签名证书&quot;">​</a></h1><p>首先，创建认证目录</p><div class="language-angular2html vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">angular2html</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>sudo mkdir -p /etc/gitlab/ssl</span></span>
<span class="line"><span>sudo chmod 700 /etc/gitlab/ssl</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>（1）创建 Private Key</p><div class="language-angular2html vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">angular2html</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>sudo openssl genrsa -des3 -out /etc/gitlab/ssl/gitlab.domain.com.key 2048</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>会提示输入密码，请记住</p><p>（2）生成 Certificate Request</p><div class="language-angular2html vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">angular2html</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>sudo openssl req -new -key /etc/gitlab/ssl/gitlab.domain.com.key -out /etc/gitlab/ssl/gitlab.domain.com.csr</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>根据提示，输入信息</p><div class="language-angular2html vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">angular2html</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>Country Name (2 letter code) [XX]:CN</span></span>
<span class="line"><span>State or Province Name (full name) []:JS</span></span>
<span class="line"><span>Locality Name (eg, city) [Default City]:NJ</span></span>
<span class="line"><span>Organization Name (eg, company) [Default Company Ltd]:xxxxx</span></span>
<span class="line"><span>Organizational Unit Name (eg, section) []:</span></span>
<span class="line"><span>Common Name (eg, your name or your server&#39;s hostname) []:gitlab.xxxx.io</span></span>
<span class="line"><span>Email Address []:</span></span>
<span class="line"><span></span></span>
<span class="line"><span>Please enter the following &#39;extra&#39; attributes</span></span>
<span class="line"><span>to be sent with your certificate request</span></span>
<span class="line"><span>A challenge password []:</span></span>
<span class="line"><span>An optional company name []:</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>（3）移除 Private Key 中的密码短语</p><div class="language-angular2html vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">angular2html</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>sudo cp -v /etc/gitlab/ssl/gitlab.domain.com.{key,original}</span></span>
<span class="line"><span>sudo openssl rsa -in /etc/gitlab/ssl/gitlab.domain.com.original -out /etc/gitlab/ssl/gitlab.domain.com.key</span></span>
<span class="line"><span>sudo rm -v /etc/gitlab/ssl/gitlab.domain.com.original</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>（4）设置文件权限</p><div class="language-angular2html vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">angular2html</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>sudo chmod 600 /etc/gitlab/ssl/gitlab.domain.com.*</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><h1 id="二、gitlab-ci-multi-runner-安装" tabindex="-1">二、gitlab-ci-multi-runner 安装 <a class="header-anchor" href="#二、gitlab-ci-multi-runner-安装" aria-label="Permalink to &quot;二、gitlab-ci-multi-runner 安装&quot;">​</a></h1><p>参考：<a href="https://docs.gitlab.com/runner/install/" target="_blank" rel="noreferrer">https://docs.gitlab.com/runner/install/</a></p><h2 id="常规安装-gitlab-ci-multi-runner" tabindex="-1">常规安装 gitlab-ci-multi-runner <a class="header-anchor" href="#常规安装-gitlab-ci-multi-runner" aria-label="Permalink to &quot;常规安装 gitlab-ci-multi-runner&quot;">​</a></h2><h2 id="下载-1" tabindex="-1">下载 <a class="header-anchor" href="#下载-1" aria-label="Permalink to &quot;下载&quot;">​</a></h2><div class="language-angular2html vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">angular2html</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>sudo wget -O /usr/local/bin/gitlab-runner https://gitlab-runner-downloads.s3.amazonaws.com/latest/binaries/gitlab-runner-linux-amd64</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><h2 id="配置执行权限" tabindex="-1">配置执行权限 <a class="header-anchor" href="#配置执行权限" aria-label="Permalink to &quot;配置执行权限&quot;">​</a></h2><div class="language-angular2html vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">angular2html</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>sudo chmod +x /usr/local/bin/gitlab-runner</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><h2 id="如果想使用-docker-安装-docker-可选的" tabindex="-1">如果想使用 Docker，安装 Docker（可选的） <a class="header-anchor" href="#如果想使用-docker-安装-docker-可选的" aria-label="Permalink to &quot;如果想使用 Docker，安装 Docker（可选的）&quot;">​</a></h2><div class="language-angular2html vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">angular2html</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>curl -sSL https://get.docker.com/ | sh</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><h2 id="创建-ci-用户" tabindex="-1">创建 CI 用户 <a class="header-anchor" href="#创建-ci-用户" aria-label="Permalink to &quot;创建 CI 用户&quot;">​</a></h2><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>sudo useradd --comment &#39;GitLab Runner&#39; --create-home gitlab-runner --shell /bin/bash</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><h2 id="安装并启动服务" tabindex="-1">安装并启动服务 <a class="header-anchor" href="#安装并启动服务" aria-label="Permalink to &quot;安装并启动服务&quot;">​</a></h2><div class="language-angular2html vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">angular2html</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>sudo gitlab-runner install --user=gitlab-runner --working-directory=/home/gitlab-runner</span></span>
<span class="line"><span>sudo gitlab-runner start</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h2 id="注册-runner" tabindex="-1">注册 Runner <a class="header-anchor" href="#注册-runner" aria-label="Permalink to &quot;注册 Runner&quot;">​</a></h2><p>（1）执行命令：</p><div class="language-angular2html vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">angular2html</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>sudo gitlab-runner register</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>（2）输入 Gitlab URL 和 令牌</p><p>URL 和令牌信息在 Gitlab 的 Runner 管理页面获取：</p><p><img src="`+p+`" alt="img_52.png" loading="lazy"></p><div class="language-angular2html vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">angular2html</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>Please enter the gitlab-ci coordinator URL (e.g. https://gitlab.com )</span></span>
<span class="line"><span>https://gitlab.com</span></span>
<span class="line"><span></span></span>
<span class="line"><span>Please enter the gitlab-ci token for this runner</span></span>
<span class="line"><span>xxx</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>（3）输入 Runner 的描述</p><div class="language-angular2html vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">angular2html</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>Please enter the gitlab-ci description for this runner</span></span>
<span class="line"><span>[hostame] my-runner</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>（4）输入 Runner 相关的标签</p><div class="language-angular2html vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">angular2html</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>Please enter the gitlab-ci tags for this runner (comma separated):</span></span>
<span class="line"><span>my-tag,another-tag</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>（5）输入 Runner 执行器</p><div class="language-angular2html vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">angular2html</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>Please enter the executor: ssh, docker+machine, docker-ssh+machine, kubernetes, docker, parallels, virtualbox, docker-ssh, shell:</span></span>
<span class="line"><span>docker</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>如果想选择 Docker 作为执行器，你需要指定默认镜像（ .gitlab-ci.yml 中没有此配置）</p><div class="language-angular2html vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">angular2html</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>Please enter the Docker image (eg. ruby:2.1):</span></span>
<span class="line"><span>alpine:latest</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h2 id="docker-安装-gitlab-ci-multi-runner" tabindex="-1">Docker 安装 gitlab-ci-multi-runner <a class="header-anchor" href="#docker-安装-gitlab-ci-multi-runner" aria-label="Permalink to &quot;Docker 安装 gitlab-ci-multi-runner&quot;">​</a></h2><p>拉取镜像</p><div class="language-angular2html vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">angular2html</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>docker pull docker.io/gitlab/gitlab-runner</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>启动</p><div class="language-angular2html vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">angular2html</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>docker run -d --name gitlab-runner --restart always \\</span></span>
<span class="line"><span>-v /srv/gitlab-runner/config:/etc/gitlab-runner \\</span></span>
<span class="line"><span>-v /var/run/docker.sock:/var/run/docker.sock \\</span></span>
<span class="line"><span>gitlab/gitlab-runner:latest</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h2 id="升级" tabindex="-1">升级 <a class="header-anchor" href="#升级" aria-label="Permalink to &quot;升级&quot;">​</a></h2><p>升级前，一定要做好备份，记录当前 gitlab 的版本号。</p><p>第一步还是使用官方命令进行升级。</p><div class="language-angular2html vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">angular2html</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>sudo yum install -y gitlab-ce</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>如果下载速度理想，就无需手动升级安装。不理想就需要停止自动更新，并手动下载安装包</p><p>访问官方地址，下载对应版本，对应系统的安装包。</p><p>注：可以根据自动升级时下载的版本，选择对应文件。</p><p><a href="https://packages.gitlab.com/gitlab/gitlab-ce" target="_blank" rel="noreferrer">https://packages.gitlab.com/gitlab/gitlab-ce</a></p><p>安装包手动上传至服务器，并替换下载未完成的安装包。下面是升级缓存地址：</p><div class="language-angular2html vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">angular2html</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>/var/cache/yum/x86_64/7/gitlab_gitlab-ce/packages/</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>再次执行官方升级命令即可完成自动安装。</p>`,82),c=[r];function o(d,u,b,h,m,g){return n(),s("div",null,c)}const y=a(t,[["render",o]]);export{k as __pageData,y as default};
